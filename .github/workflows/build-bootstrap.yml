name: Build and Deploy Bootstrap

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      VERSION: ${{ inputs.version }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO_NAME: ${{ github.repository }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate version format
        run: |
          echo "Validating version format: $VERSION"
          
          # Check if version matches semantic versioning pattern (X.Y.Z)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid version format '$VERSION'"
            echo ""
            echo "Version must follow semantic versioning pattern: X.Y.Z"
            echo "Where X, Y, and Z are non-negative integers"
            echo ""
            echo "Examples of valid versions:"
            echo "  - 1.0.0"
            echo "  - 2.3.1"
            echo "  - 10.15.3"
            echo ""
            echo "Examples of invalid versions:"
            echo "  - 1.0 (missing patch version)"
            echo "  - v1.0.0 (should not include 'v' prefix)"
            echo "  - 1.0.0-beta (pre-release tags not supported)"
            echo "  - 1.0.0+build (build metadata not supported)"
            exit 1
          fi
          
          echo "‚úÖ Version format is valid: $VERSION"
          echo "Proceeding with bootstrap build for version $VERSION"
      
      - name: Make scripts executable
        run: |
          echo "Making all scripts executable..."
          if ! chmod +x scripts/*.sh; then
            echo "‚ùå Error: Failed to make scripts executable"
            echo "This could be due to:"
            echo "  - Missing scripts directory"
            echo "  - Insufficient permissions"
            exit 1
          fi
          echo "‚úÖ All scripts are now executable"
      
      - name: Download Termux bootstrap packages
        run: |
          echo "================================================"
          echo "Step 1/7: Downloading Termux Bootstrap Packages"
          echo "================================================"
          echo ""
          
          if ! ./scripts/download-bootstraps.sh; then
            echo ""
            echo "‚ùå Error: Bootstrap download failed"
            echo "This could be due to:"
            echo "  - Network connectivity issues"
            echo "  - Termux repository unavailable"
            echo "  - Invalid bootstrap release tag"
            echo ""
            echo "Please check the logs above for specific error details"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Bootstrap download completed successfully"
      
      - name: Package bootstrap archives
        run: |
          echo ""
          echo "========================================"
          echo "Step 2/7: Packaging Bootstrap Archives"
          echo "========================================"
          echo ""
          
          if ! ./scripts/package-archives.sh "$VERSION"; then
            echo ""
            echo "‚ùå Error: Archive packaging failed"
            echo "This could be due to:"
            echo "  - Missing bootstrap directories"
            echo "  - Insufficient disk space"
            echo "  - Invalid permissions on bootstrap files"
            echo ""
            echo "Please check the logs above for specific error details"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Archive packaging completed successfully"
      
      - name: Validate bootstrap archives
        run: |
          echo ""
          echo "========================================"
          echo "Step 3/7: Validating Bootstrap Archives"
          echo "========================================"
          echo ""
          
          if ! ./scripts/validate-archives.sh; then
            echo ""
            echo "‚ùå Error: Archive validation failed"
            echo "One or more archives are invalid or incomplete"
            echo ""
            echo "Common issues:"
            echo "  - Missing critical binaries (bash, git, node, python)"
            echo "  - Incorrect file permissions"
            echo "  - Corrupted archive files"
            echo ""
            echo "Please check the validation logs above for specific failures"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Archive validation completed successfully"
      
      - name: Generate checksums and calculate sizes
        id: checksums
        run: |
          echo ""
          echo "=================================================="
          echo "Step 4/7: Generating Checksums and Calculating Sizes"
          echo "=================================================="
          echo ""
          
          # Change to archive directory
          cd bootstrap-archives
          
          if ! ../scripts/generate-checksums.sh; then
            echo ""
            echo "‚ùå Error: Checksum generation failed"
            echo "This could be due to:"
            echo "  - Missing archive files"
            echo "  - Corrupted archive files"
            echo "  - Missing sha256sum or shasum command"
            echo ""
            echo "Please check the logs above for specific error details"
            exit 1
          fi
          
          # Capture JSON output for manifest update
          if [ ! -f "checksums.json" ]; then
            echo "‚ùå Error: checksums.json file not created"
            exit 1
          fi
          
          CHECKSUM_DATA=$(cat checksums.json)
          
          # Validate JSON format
          if ! echo "$CHECKSUM_DATA" | jq empty 2>/dev/null; then
            echo "‚ùå Error: checksums.json contains invalid JSON"
            exit 1
          fi
          
          echo "checksum_data<<EOF" >> $GITHUB_OUTPUT
          echo "$CHECKSUM_DATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Move checksums files to root for release upload
          mv checksums.txt checksums.json ../ || {
            echo "‚ùå Error: Failed to move checksum files"
            exit 1
          }
          
          cd ..
          
          echo ""
          echo "‚úÖ Checksum generation completed successfully"
      
      - name: Update bootstrap manifest
        run: |
          echo ""
          echo "====================================="
          echo "Step 5/7: Updating Bootstrap Manifest"
          echo "====================================="
          echo ""
          
          if ! ./scripts/update-manifest.sh "$VERSION" "$REPO_NAME" '${{ steps.checksums.outputs.checksum_data }}'; then
            echo ""
            echo "‚ùå Error: Manifest update failed"
            echo "This could be due to:"
            echo "  - Invalid checksums JSON data"
            echo "  - Missing or corrupted manifest file"
            echo "  - jq command not available"
            echo ""
            echo "Please check the logs above for specific error details"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Manifest update completed successfully"
      
      - name: Validate manifest JSON syntax
        run: |
          echo ""
          echo "Validating updated manifest JSON syntax..."
          
          if ! jq empty bootstrap-manifest.json 2>/dev/null; then
            echo "‚ùå Error: bootstrap-manifest.json contains invalid JSON"
            echo ""
            echo "The manifest file was updated but contains syntax errors"
            echo "This should not happen if update-manifest.sh completed successfully"
            exit 1
          fi
          
          echo "‚úÖ Manifest JSON validation passed"
          echo ""
          
          # Display updated manifest for verification
          echo "Updated manifest content:"
          echo "------------------------"
          jq '.' bootstrap-manifest.json
      
      - name: Commit and push manifest changes
        run: |
          echo ""
          echo "============================================"
          echo "Step 6/7: Committing and Pushing Manifest"
          echo "============================================"
          echo ""
          
          # Configure git user
          echo "Configuring git user..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add manifest to staging
          echo "Adding manifest to git staging..."
          if ! git add bootstrap-manifest.json; then
            echo "‚ùå Error: Failed to add manifest to git staging"
            exit 1
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit in bootstrap-manifest.json"
            echo "The manifest may already be up to date"
          else
            # Show what will be committed
            echo ""
            echo "Changes to be committed:"
            git diff --staged --stat
            echo ""
            
            # Commit changes
            echo "Committing changes..."
            if ! git commit -m "Update bootstrap manifest to v$VERSION"; then
              echo "‚ùå Error: Failed to commit manifest changes"
              exit 1
            fi
            
            echo "‚úÖ Changes committed successfully"
            echo ""
            
            # Push to main branch with error handling
            echo "Pushing changes to main branch..."
            if ! git push origin HEAD:main; then
              echo ""
              echo "‚ùå Error: Failed to push manifest changes to main branch"
              echo "This could be due to:"
              echo "  - Branch protection rules requiring pull requests"
              echo "  - Insufficient permissions on GITHUB_TOKEN"
              echo "  - Network connectivity issues"
              echo "  - Conflicts with remote changes"
              echo ""
              echo "Please check repository settings and workflow permissions"
              exit 1
            fi
            
            echo "‚úÖ Manifest changes committed and pushed successfully"
          fi
      
      - name: Create GitHub release and upload assets
        id: create_release
        run: |
          echo ""
          echo "=============================================="
          echo "Step 7/7: Creating GitHub Release and Uploading Assets"
          echo "=============================================="
          echo ""
          
          # GitHub CLI is pre-installed on ubuntu-latest runners
          # Verify gh is available
          echo "Verifying GitHub CLI availability..."
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found, installing..."
            
            if ! curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null; then
              echo "‚ùå Error: Failed to download GitHub CLI keyring"
              exit 1
            fi
            
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            
            if ! sudo apt update; then
              echo "‚ùå Error: Failed to update apt package list"
              exit 1
            fi
            
            if ! sudo apt install gh -y; then
              echo "‚ùå Error: Failed to install GitHub CLI"
              exit 1
            fi
            
            echo "‚úÖ GitHub CLI installed successfully"
          else
            echo "‚úÖ GitHub CLI is available"
          fi
          
          echo ""
          echo "Verifying all archive files exist..."
          
          # Check that all required files exist
          required_files=(
            "bootstrap-archives/bootstrap-arm64-v8a-$VERSION.tar.gz"
            "bootstrap-archives/bootstrap-armeabi-v7a-$VERSION.tar.gz"
            "bootstrap-archives/bootstrap-x86_64-$VERSION.tar.gz"
            "bootstrap-archives/bootstrap-x86-$VERSION.tar.gz"
            "checksums.txt"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "  ‚úó Missing: $file"
            else
              echo "  ‚úì Found: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Error: Required files are missing"
            echo "Cannot create release without all archive files"
            exit 1
          fi
          
          echo ""
          echo "Creating release notes..."
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          Bootstrap archives for mobile code editor v$VERSION
          
          ## Architectures
          - **arm64-v8a** (64-bit ARM) - Modern Android devices
          - **armeabi-v7a** (32-bit ARM) - Older Android devices
          - **x86_64** (64-bit x86) - Emulators and tablets
          - **x86** (32-bit x86) - Older emulators
          
          ## Included Tools
          - Bash, Git, Node.js, npm, Python 3
          - Core utilities (ls, cat, grep, sed, awk, etc.)
          - Development tools (make, gcc, pkg-config)
          
          ## Checksums
          See `checksums.txt` for SHA-256 verification.
          
          ## Installation
          These archives are automatically downloaded by the mobile editor app based on device architecture.
          EOF
          
          # Substitute VERSION in release notes
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          echo "‚úÖ Release notes created"
          echo ""
          echo "Creating GitHub release with tag v$VERSION..."
          
          # Create the release with all assets
          if ! gh release create "v$VERSION" \
            --title "Bootstrap v$VERSION" \
            --notes-file release_notes.md \
            --latest \
            bootstrap-archives/bootstrap-arm64-v8a-$VERSION.tar.gz \
            bootstrap-archives/bootstrap-armeabi-v7a-$VERSION.tar.gz \
            bootstrap-archives/bootstrap-x86_64-$VERSION.tar.gz \
            bootstrap-archives/bootstrap-x86-$VERSION.tar.gz \
            checksums.txt; then
            echo ""
            echo "‚ùå Error: Failed to create GitHub release"
            echo "This could be due to:"
            echo "  - Release tag v$VERSION already exists"
            echo "  - Insufficient permissions on GITHUB_TOKEN"
            echo "  - Network connectivity issues"
            echo "  - Invalid release assets"
            echo ""
            echo "Please check if the release already exists or verify permissions"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Release created successfully!"
          echo ""
          
          # Capture release URL
          echo "Fetching release URL..."
          if ! RELEASE_URL=$(gh release view "v$VERSION" --json url --jq .url 2>/dev/null); then
            echo "‚ö†Ô∏è  Warning: Could not fetch release URL, but release was created"
            RELEASE_URL="https://github.com/$REPO_NAME/releases/tag/v$VERSION"
          fi
          
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üì¶ Successfully uploaded assets:"
          echo "  ‚úì bootstrap-arm64-v8a-$VERSION.tar.gz"
          echo "  ‚úì bootstrap-armeabi-v7a-$VERSION.tar.gz"
          echo "  ‚úì bootstrap-x86_64-$VERSION.tar.gz"
          echo "  ‚úì bootstrap-x86-$VERSION.tar.gz"
          echo "  ‚úì checksums.txt"
          echo ""
          echo "üîó Release URL: $RELEASE_URL"
      
      - name: Upload manifest to release
        run: |
          echo ""
          echo "Uploading bootstrap-manifest.json to release v$VERSION..."
          
          # Verify manifest file exists
          if [ ! -f "bootstrap-manifest.json" ]; then
            echo "‚ùå Error: bootstrap-manifest.json not found"
            echo "The manifest file should exist in the repository root"
            exit 1
          fi
          
          # Upload the manifest file to the release
          if ! gh release upload "v$VERSION" bootstrap-manifest.json --clobber; then
            echo ""
            echo "‚ùå Error: Failed to upload bootstrap-manifest.json to release"
            echo "This could be due to:"
            echo "  - Release v$VERSION not found"
            echo "  - Insufficient permissions on GITHUB_TOKEN"
            echo "  - Network connectivity issues"
            echo "  - File upload size limits"
            echo ""
            echo "Please verify the release exists and check permissions"
            exit 1
          fi
          
          echo "‚úÖ Manifest uploaded successfully"
          echo ""
          
          # Verify manifest URL is accessible
          echo "Verifying manifest URL accessibility..."
          MANIFEST_URL="https://github.com/$REPO_NAME/releases/download/v$VERSION/bootstrap-manifest.json"
          echo "Manifest URL: $MANIFEST_URL"
          
          # Wait a moment for GitHub to process the upload
          echo "Waiting for GitHub CDN to propagate..."
          sleep 5
          
          # Verify the manifest is accessible
          echo "Testing manifest URL..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L "$MANIFEST_URL")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Manifest URL is accessible (HTTP $HTTP_STATUS)"
            
            # Download and verify it's valid JSON
            echo "Validating downloaded manifest..."
            if curl -s -L "$MANIFEST_URL" | jq empty 2>/dev/null; then
              echo "‚úÖ Downloaded manifest is valid JSON"
            else
              echo "‚ö†Ô∏è  Warning: Downloaded manifest may not be valid JSON"
              echo "This could be a temporary CDN issue"
            fi
          else
            echo "‚ö†Ô∏è  Warning: Manifest URL returned HTTP $HTTP_STATUS"
            echo "The manifest was uploaded but may not be immediately accessible"
            echo "This is often due to GitHub CDN propagation delay (can take 1-2 minutes)"
            echo ""
            echo "Please verify manually after a few minutes: $MANIFEST_URL"
            echo ""
            echo "Note: This is not a critical error - the manifest is uploaded"
          fi
          
          echo ""
          echo "üìÑ Additional asset uploaded to release:"
          echo "  ‚úì bootstrap-manifest.json"
      
      - name: Workflow Summary
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "           WORKFLOW EXECUTION SUMMARY"
          echo "=================================================="
          echo ""
          echo "Version: $VERSION"
          echo "Repository: $REPO_NAME"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Status: SUCCESS"
            echo ""
            echo "üì¶ Created Assets:"
            echo "  ‚úì bootstrap-arm64-v8a-$VERSION.tar.gz"
            echo "  ‚úì bootstrap-armeabi-v7a-$VERSION.tar.gz"
            echo "  ‚úì bootstrap-x86_64-$VERSION.tar.gz"
            echo "  ‚úì bootstrap-x86-$VERSION.tar.gz"
            echo "  ‚úì checksums.txt"
            echo "  ‚úì bootstrap-manifest.json"
            echo ""
            echo "üîó Release URL:"
            echo "   ${{ steps.create_release.outputs.release_url }}"
            echo ""
            echo "üìã Manifest URL:"
            echo "   https://github.com/$REPO_NAME/releases/download/v$VERSION/bootstrap-manifest.json"
            echo ""
            echo "‚ú® All bootstrap archives have been built, validated, and published!"
            echo "   The mobile app can now download bootstrap v$VERSION"
          else
            echo "‚ùå Status: FAILED"
            echo ""
            echo "The workflow encountered errors during execution."
            echo "Please review the logs above to identify the failure point."
            echo ""
            echo "Common failure scenarios:"
            echo "  - Network issues downloading Termux packages"
            echo "  - Archive validation failures (missing binaries)"
            echo "  - Permission issues creating release or pushing commits"
            echo "  - Invalid version format"
            echo ""
            echo "Check the specific step that failed for detailed error messages."
          fi
          echo ""
          echo "=================================================="
