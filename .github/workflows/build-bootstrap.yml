name: Build and Deploy Bootstrap

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      build_modes:
        description: 'Build modes to create (comma-separated: static,linux-native,android-native)'
        required: false
        default: 'static'
        type: string
      architectures:
        description: 'Architectures to build (comma-separated: arm64-v8a,armeabi-v7a,x86_64,x86)'
        required: false
        default: 'x86_64'
        type: string
      run_tests:
        description: 'Run PRoot compatibility tests'
        required: false
        default: true
        type: boolean

jobs:
  # Prepare matrix from comma-separated inputs
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      modes: ${{ steps.set-matrix.outputs.modes }}
      archs: ${{ steps.set-matrix.outputs.archs }}
    steps:
      - name: Set matrix values
        id: set-matrix
        run: |
          # Convert comma-separated strings to JSON arrays
          MODES=$(echo '${{ inputs.build_modes }}' | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          ARCHS=$(echo '${{ inputs.architectures }}' | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          
          echo "modes=$MODES" >> $GITHUB_OUTPUT
          echo "archs=$ARCHS" >> $GITHUB_OUTPUT
          
          echo "Build modes: $MODES"
          echo "Architectures: $ARCHS"
  
  # Matrix job to build multiple modes and architectures in parallel
  build-bootstrap:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        mode: ${{ fromJson(needs.prepare-matrix.outputs.modes) }}
        arch: ${{ fromJson(needs.prepare-matrix.outputs.archs) }}
      fail-fast: false
    
    env:
      VERSION: ${{ inputs.version }}
      BUILD_MODE: ${{ matrix.mode }}
      TARGET_ARCH: ${{ matrix.arch }}
      RUN_TESTS: ${{ inputs.run_tests }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO_NAME: ${{ github.repository }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup build environment
        run: |
          echo "================================================"
          echo "Setting up build environment"
          echo "================================================"
          echo "Mode: $BUILD_MODE"
          echo "Architecture: $TARGET_ARCH"
          echo "Version: $VERSION"
          echo ""
          
          # Make scripts executable
          chmod +x scripts/*.sh
          
          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            wget \
            curl \
            jq \
            xz-utils \
            zstd \
            bzip2 \
            file \
            patchelf \
            qemu-user-static
          
          echo "✅ Build environment ready"
      
      - name: Validate configuration
        run: |
          echo "================================================"
          echo "Step 1/7: Configuration Validation"
          echo "================================================"
          
          # Create temporary config for this build
          cat > build-config-temp.json << 'EOF'
          {
            "version": "$VERSION",
            "buildMode": "$BUILD_MODE",
            "architectures": ["$TARGET_ARCH"],
            "compression": "xz",
            "stripSymbols": true,
            "runTests": $RUN_TESTS,
            "staticOptions": {
              "libc": "musl",
              "optimizationLevel": "Os"
            },
            "linuxNativeOptions": {
              "linkerPath": "/lib/ld-linux-aarch64.so.1",
              "libPaths": ["/lib", "/lib64", "/usr/lib"]
            },
            "packages": {
              "busybox": {
                "version": "1.36.1",
                "source": "https://busybox.net/downloads/busybox-1.36.1.tar.bz2",
                "checksum": "b8cc24c9574d809e7279c3be349795c5d5ceb6fdf19ca709f80cde50e47de314",
                "buildStatic": true
              },
              "bash": {
                "version": "5.2",
                "source": "https://ftp.gnu.org/gnu/bash/bash-5.2.tar.gz",
                "checksum": "a139c166df7ff4471c5e0733051642ee5556c1cc8a4a78f145583c5c81ab32fb",
                "buildStatic": true
              }
            }
          }
          EOF
          
          # Replace placeholders with actual values
          sed -i "s/\$VERSION/$VERSION/g" build-config-temp.json
          sed -i "s/\$BUILD_MODE/$BUILD_MODE/g" build-config-temp.json
          sed -i "s/\$TARGET_ARCH/$TARGET_ARCH/g" build-config-temp.json
          sed -i "s/\$RUN_TESTS/$RUN_TESTS/g" build-config-temp.json
          
          # Validate configuration
          ./scripts/config-validator.sh build-config-temp.json
          
          echo "✅ Configuration validated"
      
      - name: Download source packages
        if: ${{ matrix.mode != 'android-native' }}
        run: |
          echo "================================================"
          echo "Step 2/7: Source Package Download"
          echo "================================================"
          
          ./scripts/download-sources.sh
          
          echo "✅ Sources downloaded and verified"
      
      - name: Compile binaries
        if: ${{ matrix.mode != 'android-native' }}
        run: |
          echo "================================================"
          echo "Step 3/7: Compilation ($BUILD_MODE mode)"
          echo "================================================"
          
          if [ "$BUILD_MODE" = "static" ]; then
            ./scripts/build-static.sh --arch "$TARGET_ARCH" --version "$VERSION"
          elif [ "$BUILD_MODE" = "linux-native" ]; then
            ./scripts/build-linux-native.sh --android-arch "$TARGET_ARCH" --version "$VERSION"
          fi
          
          echo "✅ Compilation completed"
      
      - name: Download android-native bootstrap
        if: ${{ matrix.mode == 'android-native' }}
        run: |
          echo "================================================"
          echo "Step 2-3/7: Download Android-Native Bootstrap"
          echo "================================================"
          echo "⚠️  WARNING: android-native mode is deprecated"
          echo "These binaries are NOT PRoot compatible"
          
          ./scripts/download-bootstraps.sh
          
          echo "✅ Android-native bootstrap downloaded"
      
      - name: Assemble bootstrap
        if: ${{ matrix.mode != 'android-native' }}
        run: |
          echo "================================================"
          echo "Step 4/7: Bootstrap Assembly"
          echo "================================================"
          
          ./scripts/assemble-bootstrap.sh --mode "$BUILD_MODE" --arch "$TARGET_ARCH" --version "$VERSION"
          
          echo "✅ Bootstrap assembled"
      
      - name: Test PRoot compatibility
        if: ${{ inputs.run_tests && matrix.mode != 'android-native' }}
        run: |
          echo "================================================"
          echo "Step 5/7: PRoot Compatibility Testing"
          echo "================================================"
          
          ./scripts/test-proot-compatibility.sh --mode "$BUILD_MODE" --arch "$TARGET_ARCH" --version "$VERSION"
          
          echo "✅ PRoot tests passed"
      
      - name: Package archive
        run: |
          echo "================================================"
          echo "Step 6/7: Archive Packaging"
          echo "================================================"
          
          ./scripts/package-archives.sh --version "$VERSION" --mode "$BUILD_MODE" --arch "$TARGET_ARCH"
          
          echo "✅ Archive packaged"
      
      - name: Generate checksums
        id: checksums
        run: |
          echo "================================================"
          echo "Step 7/7: Checksum Generation"
          echo "================================================"
          
          cd bootstrap-archives
          ../scripts/generate-checksums.sh --version "$VERSION" --mode "$BUILD_MODE" --arch "$TARGET_ARCH"
          
          # Save checksum data for manifest
          CHECKSUM_DATA=$(cat "checksums-${BUILD_MODE}-${TARGET_ARCH}.json")
          echo "checksum_data<<EOF" >> $GITHUB_OUTPUT
          echo "$CHECKSUM_DATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          cd ..
          
          echo "✅ Checksums generated"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-${{ matrix.mode }}-${{ matrix.arch }}-${{ inputs.version }}
          path: |
            bootstrap-archives/bootstrap-${{ matrix.mode }}-${{ matrix.arch }}-${{ inputs.version }}.tar.xz
            bootstrap-archives/checksums-${{ matrix.mode }}-${{ matrix.arch }}.txt
            bootstrap-archives/checksums-${{ matrix.mode }}-${{ matrix.arch }}.json
            test-results/test-report-${{ matrix.mode }}-${{ matrix.arch }}.json
          retention-days: 7
          if-no-files-found: error
  
  # Deploy job runs after all builds complete
  deploy:
    needs: build-bootstrap
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      VERSION: ${{ inputs.version }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO_NAME: ${{ github.repository }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x scripts/*.sh
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Organize artifacts
        run: |
          echo "================================================"
          echo "Organizing Build Artifacts"
          echo "================================================"
          
          mkdir -p bootstrap-archives test-results
          
          # Move archives and checksums
          find artifacts -name "*.tar.xz" -exec mv {} bootstrap-archives/ \;
          find artifacts -name "checksums-*.txt" -exec mv {} bootstrap-archives/ \;
          find artifacts -name "checksums-*.json" -exec mv {} bootstrap-archives/ \;
          find artifacts -name "test-report-*.json" -exec mv {} test-results/ \; 2>/dev/null || true
          
          # List what we have
          echo ""
          echo "Archives:"
          ls -lh bootstrap-archives/*.tar.xz
          echo ""
          echo "Checksums:"
          ls -lh bootstrap-archives/checksums-*.{txt,json}
          echo ""
          echo "Test Reports:"
          ls -lh test-results/*.json 2>/dev/null || echo "No test reports"
          
          echo "✅ Artifacts organized"
      
      - name: Update bootstrap manifest
        run: |
          echo "================================================"
          echo "Updating Bootstrap Manifest"
          echo "================================================"
          
          # Get base URL for test reports
          TEST_REPORT_BASE="https://github.com/$REPO_NAME/releases/download/v$VERSION"
          
          # Update manifest for each mode/arch combination
          for checksum_file in bootstrap-archives/checksums-*.json; do
            if [ -f "$checksum_file" ]; then
              # Extract mode and arch from filename
              filename=$(basename "$checksum_file")
              MODE_ARCH=$(echo "$filename" | sed 's/checksums-\(.*\)\.json/\1/')
              
              echo "Updating manifest for: $MODE_ARCH"
              
              CHECKSUM_DATA=$(cat "$checksum_file")
              
              # Update manifest
              ./scripts/update-manifest.sh "$VERSION" "$REPO_NAME" "$CHECKSUM_DATA" "$MODE_ARCH" "$TEST_REPORT_BASE"
              
              echo "✅ Manifest updated for $MODE_ARCH"
            fi
          done
          
          echo "✅ All manifest updates completed"
      
      - name: Validate manifest
        run: |
          echo "================================================"
          echo "Validating Manifest"
          echo "================================================"
          
          if ! jq empty bootstrap-manifest.json; then
            echo "❌ Error: Invalid JSON in manifest"
            exit 1
          fi
          
          echo "✅ Manifest validated"
          echo ""
          echo "Manifest summary:"
          jq '.version, .releaseDate, .bootstraps | keys' bootstrap-manifest.json
      
      - name: Commit and push manifest
        run: |
          echo "================================================"
          echo "Committing Manifest Changes"
          echo "================================================"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add bootstrap-manifest.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update bootstrap manifest to v$VERSION"
            git push origin HEAD:main
            echo "✅ Manifest committed and pushed"
          fi
      
      - name: Create GitHub release
        id: create_release
        run: |
          echo "================================================"
          echo "Creating GitHub Release"
          echo "================================================"
          
          # Collect all files
          ARCHIVE_FILES=(bootstrap-archives/*.tar.xz)
          CHECKSUM_FILES=(bootstrap-archives/checksums-*.txt)
          TEST_REPORTS=(test-results/*.json)
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          Bootstrap archives for mobile code editor v${{ inputs.version }}
          
          ## Build Modes
          - **static**: Statically-linked binaries (PRoot compatible, recommended)
          - **linux-native**: Dynamically-linked with Linux linker (PRoot compatible)
          - **android-native**: Android-native binaries (not PRoot compatible)
          
          ## Architectures
          - arm64-v8a, armeabi-v7a, x86_64, x86
          
          ## Included Tools
          - Bash shell
          - BusyBox utilities (300+ Unix commands)
          - Core utilities
          
          ## PRoot Compatibility
          Static and linux-native modes are tested for PRoot compatibility.
          EOF
          
          # Create release
          gh release create "v$VERSION" \
            --title "Bootstrap v$VERSION" \
            --notes-file release_notes.md \
            --latest \
            "${ARCHIVE_FILES[@]}" \
            "${CHECKSUM_FILES[@]}" \
            "${TEST_REPORTS[@]}" \
            bootstrap-manifest.json
          
          RELEASE_URL=$(gh release view "v$VERSION" --json url --jq .url)
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          
          echo "✅ Release created: $RELEASE_URL"
      
      - name: Workflow summary
        if: always()
        run: |
          echo "================================================"
          echo "WORKFLOW SUMMARY"
          echo "================================================"
          echo "Version: $VERSION"
          echo "Status: ${{ job.status }}"
          echo "Release: ${{ steps.create_release.outputs.release_url }}"
          echo "================================================"
